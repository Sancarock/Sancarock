<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rádio SancaRock</title>
<style>
body {
  margin: 0;
  font-family: 'Bebas Neue', Arial, sans-serif;
  background: radial-gradient(circle at center, #ff4500, #800080, #000);
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}
.player-container {
  background: url("img/fundoradio.png") no-repeat center center fixed;
  background-size: cover;
  backdrop-filter: blur(10px);
  border-radius: 25px;
  padding: 25px;
  width: 90%;
  max-width: 460px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0,0,0,0.7);
  border:1px solid rgba(255,69,0,0.3);
}
.album-cover {
  display: block;
  width: 50%;
  max-width: 150px;
  border-radius: 16px;
  border: 3px solid #ff4500;
  margin: 40px auto 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.8);
  opacity: 0.95;
  filter: brightness(1.3);
  transition: opacity 1s ease-in-out, filter 0.5s ease-in-out;
}
.track-info {
  margin-top: 15px;
  font-size: 22px;
  color: yellow;
}
#artistName {
  margin-top: 5px;
  font-size: 18px;
  color: #fff;
}
.controls button {
  padding:12px 20px; font-size:16px; cursor:pointer; border:none; border-radius:25px; color:white; font-weight:bold;
}
.play-button{background:linear-gradient(135deg,#28a745,#1e7e34);}
.pause-button{background:linear-gradient(135deg,#dc3545,#c82333);}
.mail-button{background:linear-gradient(135deg,#6f42c1,#5a32a3);}
.equalizer {
  display: flex;
  justify-content: center;
  gap: 6px;
  height: 30px;
  margin-top: 25px;
}
.equalizer span {
  width: 10px;
  background: linear-gradient(180deg,#ff4500,#ff1493,#da70d6);
  border-radius: 3px;
  animation: bounce 1.2s infinite ease-in-out;
}
.equalizer span:nth-child(2){animation-delay:0.15s;}
.equalizer span:nth-child(3){animation-delay:0.3s;}
.equalizer span:nth-child(4){animation-delay:0.45s;}
.equalizer span:nth-child(5){animation-delay:0.6s;}
@keyframes bounce {
  0%,100%{transform:scaleY(0.3);}
  50%{transform:scaleY(1.8);}
}
</style>
</head>
<body>
<div class="player-container">

  <div class="equalizer">
    <span></span><span></span><span></span><span></span><span></span>
  </div>

  <img id="albumCover" src="img/sanca.png" class="album-cover" alt="Capa do Álbum">

  <div class="track-info" id="trackTitle">Carregando música...</div>
  <div id="artistName">Aguardando artista...</div>

  <audio id="radioPlayer" controls autoplay preload="auto">
      <source src="https://stream.zeno.fm/0y2f0ss7kbruv" type="audio/mpeg">
      Seu navegador não suporta áudio.
  </audio>

  <div class="controls">
    <button class="mail-button" onClick="window.location.href='mailto:sancanight@gmail.com?subject=Contato&body=Olá!'">Contato</button>
    <button class="play-button" onClick="history.go(0)">Atualizar</button>
  </div>
</div>
<script>
const titleEl = document.getElementById('trackTitle');
const artistEl = document.getElementById('artistName');
const coverEl = document.getElementById('albumCover');
const player = document.getElementById('radioPlayer');
const apiKeyLastFm = 'd08d389671438f325d13d64f0c94b583';
let lastTrack = '';

const streams = [
  "https://stream.zeno.fm/0y2f0ss7kbruv",
  "https://s02.transmissaodigital.com:6716/stream"
];

let currentStream = 0;
let triedStreams = 0;
let lastTime = 0;

// Função para tocar stream
function playStream() {
  triedStreams = 0;
  player.src = streams[currentStream];
  player.play().catch(() => {
    console.warn('Erro ao iniciar stream, tentando próximo...');
    nextStream();
  });
}

// Alterna para o próximo stream de forma segura
function nextStream() {
  triedStreams++;
  if(triedStreams > streams.length){
    console.warn('Nenhum stream disponível no momento.');
    return;
  }
  currentStream = (currentStream + 1) % streams.length;
  setTimeout(() => {
    player.src = streams[currentStream];
    player.play().catch(nextStream);
  }, 1000);
}

// Fallback automático por erro
player.addEventListener('error', nextStream);

// Detecta travamento silencioso
setInterval(() => {
  if(player.paused) return; // se pausado, ignora
  if(player.currentTime === lastTime){
    console.warn('Stream travado, alternando...');
    nextStream();
  } else {
    lastTime = player.currentTime;
  }
}, 5000); // checa a cada 5 segundos

// Atualiza metadata e capa
async function updateMetadata(){
  try{
    const res = await fetch('https://transmissaodigital.com/api/VG1wamVFNW5QVDA9KzU=');
    const buffer = await res.arrayBuffer();
    let afterKbps = new TextDecoder('iso-8859-1').decode(buffer)
      .split('Kbps').pop()
      .replace(/https?:\/\/[^\s]*/g,'')
      .replace(/<[^>]*>/g,'')
      .trim();

    if(!afterKbps || afterKbps === lastTrack) return;
    lastTrack = afterKbps;

    afterKbps = afterKbps.replace(/(\d+,)+\d+,?/g,'').trim();

    let artist='', track='';
    if(afterKbps.includes(' - ')){
      [artist, track] = afterKbps.split(' - ').map(s=>s.trim());
    } else { track = afterKbps; }

    titleEl.textContent = track || '---';
    artistEl.textContent = artist || '---';
    document.title = `${artist} - ${track} | Rádio SancaRock`;

    // Capa
    if((artist + ' ' + track).toLowerCase().includes('monstros do rock')){
      coverEl.src = 'img/monstrosdorock.png';
    } else {
      let cover = await fetchCoveriTunes(artist || track, track);
      if(!cover) cover = await fetchCoverLastFm(artist || track, track);
      coverEl.src = cover || 'img/sanca.png';
    }

  } catch(e){ console.warn(e); }
}

// Funções de busca de capa
async function fetchCoveriTunes(artist, track){
  try{
    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist+' '+track)}&entity=song&limit=5`);
    const data = await res.json();
    if(data.results?.length>0){
      const match = data.results.find(r=>r.artistName.toLowerCase().includes(artist.toLowerCase()));
      if(match) return match.artworkUrl100.replace("100x100","600x600");
    }
  } catch(e){ return null; }
  return null;
}

async function fetchCoverLastFm(artist, track){
  try{
    const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${apiKeyLastFm}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(track)}&format=json`);
    const data = await res.json();
    const images = data?.track?.album?.image;
    if(images) return images.find(img=>img.size==='extralarge')?.['#text'];
  } catch(e){ return null; }
  return null;
}

// Atualiza metadata a cada 30s
updateMetadata();
setInterval(updateMetadata, 30000);

// Inicia a reprodução
playStream();
</script>


</body>
</html>
