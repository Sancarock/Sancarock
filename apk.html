<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Capa do Álbum</title>
<style>
  body {
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #albumArt {
    width: 300px;
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
  }
</style>
</head>
<body>

<img id="albumArt" src="img/padrao.png" alt="Capa do álbum">

<script>
const apiKey = "d08d389671438f325d13d64f0c94b583";
const urlMusica = "http://s02.transmissaodigital.com:6716/currentsong?sid=1";
const proxy = location.protocol === "https:" ? "" : "https://api.allorigins.win/raw?url="; 
let ultimaMusica = "";

async function buscarImagem(artista, faixa) {
  try {
    // Tenta buscar capa do álbum
    const urlTrack = `${proxy}https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${apiKey}&artist=${encodeURIComponent(artista)}&track=${encodeURIComponent(faixa)}&format=json`;
    const dadosTrack = await fetch(urlTrack).then(r => r.json());
    const albumImg = dadosTrack?.track?.album?.image?.pop()?.['#text'];
    if (albumImg) return albumImg;

    // Se não tiver álbum, busca imagem do artista
    const urlArtist = `${proxy}https://ws.audioscrobbler.com/2.0/?method=artist.getInfo&api_key=${apiKey}&artist=${encodeURIComponent(artista)}&format=json`;
    const dadosArtist = await fetch(urlArtist).then(r => r.json());
    const artistImg = dadosArtist?.artist?.image?.pop()?.['#text'];
    if (artistImg) return artistImg;

    // Se nada encontrado, retorna padrão
    return "img/padrao.png";
  } catch (e) {
    console.error("Erro ao buscar imagem:", e);
    return "img/padrao.png";
  }
}

async function atualizarCapa() {
  try {
    const res = await fetch(urlMusica + "&_=" + Date.now());
    const musicaAtual = (await res.text()).trim();

    if (!musicaAtual || musicaAtual === ultimaMusica) return;

    ultimaMusica = musicaAtual;
    console.log("Nova música:", musicaAtual);

    // Regex para separar artista e faixa (funciona mesmo com hífens na música)
    const match = musicaAtual.match(/^(.+?)\s*-\s*(.+)$/);
    if (!match) return;

    const artista = match[1].trim();
    const faixa = match[2].trim();

    const imagem = await buscarImagem(artista, faixa);
    document.getElementById("albumArt").src = imagem;

  } catch (e) {
    console.error("Erro ao atualizar capa:", e);
  }
}

// Atualiza a cada 10 segundos
setInterval(atualizarCapa, 10000);
atualizarCapa();
</script>

</body>
</html>
