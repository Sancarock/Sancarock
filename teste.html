<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rádio SancaRock</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; background:#000; color:#fff; }
  #albumCover { width:150px; border-radius:10px; margin:20px auto; display:block; }
</style>
</head>
<body>

<h1>Rádio SancaRock</h1>
<img id="albumCover" src="img/tocar.png" alt="Capa do Álbum">
<p id="trackTitle">Carregando...</p>
<p id="artistName"></p>
<audio id="radioPlayer" preload="auto"></audio>

<script>
const radio = document.getElementById('radioPlayer');
const trackTitle = document.getElementById('trackTitle');
const artistName = document.getElementById('artistName');
const albumCover = document.getElementById('albumCover');

const apiKeyLastFm = 'd08d389671438f325d13d64f0c94b583';
let lastTrack = '';

// URL do streaming direto
radio.src = "https://s02.transmissaodigital.com:6716/stream;";
radio.volume = 0.2;

// ---------------- Atualiza Metadata ----------------
async function updateMetadata(){
  try {
    const res = await fetch('https://transmissaodigital.com/api/VG1wamVFNW5QVDA9KzU=');
    const buffer = await res.arrayBuffer();
    let afterKbps = new TextDecoder('iso-8859-1').decode(buffer)
      .split('Kbps').pop()
      .replace(/https?:\/\/[^\s]*/g,'')
      .replace(/<[^>]*>/g,'').trim();

    if(!afterKbps || afterKbps === lastTrack) return;
    lastTrack = afterKbps;

    let artist='', track='';
    if(afterKbps.includes(' - ')){
      [artist, track] = afterKbps.split(' - ').map(s=>s.trim());
    } else { track = afterKbps; }

    trackTitle.textContent = track;
    artistName.textContent = artist;
    document.title = `${artist} - ${track} | Rádio SancaRock`;

    // Busca capa (fallback)
    albumCover.src = 'img/sanca.png';
  } catch(e){ console.warn(e); }
}

// Atualiza a cada 30s
setInterval(updateMetadata, 30000);
updateMetadata();

// ---------------- Auto play ----------------
radio.play().catch(()=>{ console.warn("Auto play bloqueado pelo navegador."); });

</script>
  <script>
async function atualizarAbaComCapa() {
    try {
        const res = await fetch('https://transmissaodigital.com/api/VG1wamVFNW5QVDA9KzU=');
        const buffer = await res.arrayBuffer();
        let musica = new TextDecoder('iso-8859-1').decode(buffer)
                      .split('Kbps').pop().replace(/https?:\/\/[^\s]*/g,'').replace(/<[^>]*>/g,'').trim();
        
        let artista='', faixa=musica;
        if(musica.includes(' - ')) [artista, faixa] = musica.split(' - ').map(s=>s.trim());
        
        // Atualiza título da aba
        document.title = artista ? `${artista} - ${faixa} | Rádio Sanca Rock` : `${faixa} | Rádio Sanca Rock`;

        // Busca a capa (iTunes como fallback)
        let coverUrl = await fetchCoveriTunes(artista || faixa, faixa);
        if(!coverUrl) coverUrl = 'img/sanca.png'; // fallback

        // Atualiza favicon
        let link = document.querySelector("link[rel*='icon']");
        if(!link){
            link = document.createElement('link');
            link.rel = 'icon';
            document.head.appendChild(link);
        }
        link.href = coverUrl;

    } catch(e){ console.warn(e); }
}

// Função de exemplo para buscar capa no iTunes
async function fetchCoveriTunes(artist, track){
    try {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist+' '+track)}&entity=song&limit=1`);
        const data = await res.json();
        if(data.results?.length>0){
            return data.results[0].artworkUrl100.replace("100x100","64x64");
        }
    } catch(e){ return null; }
    return null;
}

// Atualiza a cada 10s
setInterval(atualizarAbaComCapa, 10000);
atualizarAbaComCapa();
</script>

</body>
</html>

